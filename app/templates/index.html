<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeNarrator AI – Smart Code Explainer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PrismJS (code highlighting) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center font-[Inter] transition-colors duration-300">

  <header class="text-center mt-10 mb-6">
    <h1 class="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400 drop-shadow-sm">🧠 CodeNarrator AI</h1>
    <p class="text-gray-600 dark:text-gray-300 mt-2 text-sm max-w-md mx-auto">
      Upload a Python file and get instant AI-generated explanations for every function.
    </p>

    <!-- Theme Toggle -->
    <div class="mt-3">
      <button id="themeToggle"
        class="px-3 py-1 text-xs rounded-lg border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
        🌙 Dark Mode
      </button>
    </div>
  </header>

  <section class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-[90%] max-w-4xl">
    <form id="uploadForm" class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6" enctype="multipart/form-data">
      <input type="file" name="code_file" accept=".py" required
        class="flex-1 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none dark:bg-gray-900 dark:text-gray-100">
      <button type="submit"
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-lg transition">
        Analyze
      </button>
    </form>

    <div class="flex justify-end gap-3 mb-3">
      <button id="exportBtn"
        class="hidden bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold px-4 py-2 rounded-lg transition">
        📄 Export PDF
      </button>
    </div>

    <div id="output" class="space-y-6 overflow-y-auto max-h-[65vh] px-1"></div>
    <div id="historySection" class="mt-6 hidden">
      <h3 class="font-semibold text-indigo-600 dark:text-indigo-400 text-sm mb-2">Recent Analyses</h3>
      <div id="historyList" class="flex flex-wrap gap-2"></div>
    </div>
  </section>

  <footer class="text-xs text-gray-400 mt-6 mb-4">© 2025 CodeNarrator AI by Karthik</footer>

  <script>
    const root = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');
    const output = document.getElementById('output');
    const uploadForm = document.getElementById('uploadForm');
    const exportBtn = document.getElementById('exportBtn');

    // Load theme
    if (localStorage.getItem('theme') === 'dark') {
      root.classList.add('dark');
      toggleBtn.textContent = '☀️ Light Mode';
    }

    toggleBtn.addEventListener('click', () => {
      root.classList.toggle('dark');
      const isDark = root.classList.contains('dark');
      toggleBtn.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // File upload and analysis
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = `
        <div class="flex justify-center items-center gap-2 text-gray-600 py-10">
          <svg class="animate-spin h-6 w-6 text-indigo-600" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span class="text-sm font-medium">Analyzing your code...</span>
        </div>`;
      exportBtn.classList.add('hidden');

      try {
        const formData = new FormData(e.target);
        const response = await fetch('/analyze', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(await response.text());
        const result = await response.json();

        if (result.status === 'success') {
          renderResults(result.analysis);
          saveHistory(result.analysis);
          renderHistory();
        } else {
          output.innerHTML = `<p class="text-red-600 font-medium">⚠️ ${result.message}</p>`;
        }
      } catch (err) {
        output.innerHTML = `<p class="text-red-600 font-medium">❌ Error: ${err.message}</p>`;
        console.error(err);
      }
    });

    function renderResults(analysis) {
      output.innerHTML = '';
      analysis.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = "bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-5 shadow-sm hover:shadow-md transition-all";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h2 class="font-semibold text-indigo-700 dark:text-indigo-400 text-base">Function ${i + 1}: ${item.function}</h2>
            <button class="text-xs text-gray-500 hover:text-indigo-600 copy-btn" data-summary="${item.summary}">📋 Copy</button>
          </div>
          <div class="grid sm:grid-cols-2 gap-4">
            <pre class="language-python rounded-lg text-sm"><code class="language-python">${item.code}</code></pre>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
              <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">🧠 ${item.summary}</p>
            </div>
          </div>`;
        output.appendChild(card);
      });
      Prism.highlightAll();

      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await navigator.clipboard.writeText(btn.dataset.summary);
          btn.textContent = '✅ Copied!';
          setTimeout(() => (btn.textContent = '📋 Copy'), 1500);
        });
      });
      exportBtn.classList.remove('hidden');
    }

    // Save last 3 analyses
    function saveHistory(data) {
      let history = JSON.parse(localStorage.getItem('history') || "[]");
      history.unshift(data);
      if (history.length > 3) history.pop();
      localStorage.setItem('history', JSON.stringify(history));
    }

    function renderHistory() {
      const data = JSON.parse(localStorage.getItem('history') || "[]");
      const list = document.getElementById('historyList');
      const section = document.getElementById('historySection');
      if (!data.length) return;
      section.classList.remove('hidden');
      list.innerHTML = '';
      data.forEach((entry, i) => {
        const btn = document.createElement('button');
        btn.className = "px-3 py-1 text-xs bg-gray-100 dark:bg-gray-800 rounded hover:bg-gray-200 dark:hover:bg-gray-700";
        btn.textContent = `Analysis ${i + 1}`;
        btn.onclick = () => renderResults(entry);
        list.appendChild(btn);
      });
    }
    renderHistory();

    // PDF export
    exportBtn.addEventListener('click', () => {
      const opt = {
        margin: 0.5,
        filename: 'CodeNarrator_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(output).save();
    });
  </script>
</body>
</html>
